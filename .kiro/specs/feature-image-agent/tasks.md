# Implementation Plan

- [x] 1. フォールバックスプライトの準備と提供機構の構築
- [x] 1.1 (P) フォールバック用の予備画像をプロジェクトの公開ディレクトリに配置する
  - 汎用フォールバックスプライト画像（PNG）を作成し `public/fallback-sprites/` に格納する
  - 最小限のインラインSVGも最終手段として定義する
  - _Requirements: 3.1, 3.4, 3.5_

- [x] 1.2 (P) フォールバック画像の事前読み込みと即時提供を行うサービスを実装する
  - アプリ起動時にフォールバック画像を非同期プリロードする
  - エンティティ種別を受け取り、対応する画像URLを返す（MVP は汎用1枚を返す）
  - プリロード失敗時はインラインSVGを返し、1秒以内に提供可能な状態を保証する
  - 読み込み完了状態の問い合わせ手段を提供する
  - _Requirements: 3.1, 3.4, 3.5_
  - _Contracts: FallbackSpriteStoreInterface_

- [ ] 2. Cloud Run サーバーへの画像生成エンドポイント追加
- [x] 2.1 既存の FastAPI サーバーに画像生成用 API エンドポイントを追加する
  - `packages/server/main.py` に `POST /api/generate-image` エンドポイントを追加する
  - エンティティ種別からピクセルアート向けプロンプトを構築し、Gemini API（Vertex AI 経由）で画像を生成する
  - 生成結果を Base64 形式でレスポンスボディに含めて返却する
  - リクエスト入力のバリデーション（エンティティ種別の必須チェック）を行う
  - _Requirements: 2.1_
  - _Contracts: ImageGenerationEndpoint API_

- [x] 2.2 (P) クライアントの Vite dev プロキシを設定し、画像生成 API へのリクエストを転送する
  - `vite.config.ts` に `/api` パスのプロキシ設定を追加し、ローカル開発時は `localhost:8080` へ転送する
  - 本番環境では Cloud Run の URL へ直接リクエストする構成を想定する
  - _Requirements: 2.1_

- [ ] 3. 画像生成エージェントサービスの中核ロジック構築
- [x] 3.1 スポーン入力のバリデーションと要求識別子の生成を実装する
  - スポーン入力の型・値・形式を検証し、空値・未定義・不正形式を拒否する
  - 受理した要求に一意な識別子を付与する
  - 生成要求と元パッチの対応関係を保持する仕組みを構築する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - _Contracts: ImageAgentServiceInterface_

- [x] 3.2 Cloud Run サーバーの画像生成エンドポイントを呼び出し、結果バリデーションを行うクライアント側ロジックを実装する
  - エンティティ種別を含むリクエストをプロキシ経由でサーバーへ送信する
  - 返却された画像データの受理可否を判定する（形式・破損チェック）
  - 受理された画像にスポーン対応のメタデータを付与して保持する
  - Three.js 側へ受け渡し可能なテクスチャ参照情報（Data URL）を生成する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - _Contracts: ImageAgentServiceInterface_

- [x] 3.3 タイムアウト制御とフォールバック判定ロジックを実装する
  - 生成要求の開始から規定待機時間を超過した場合にフォールバックを即時採用する
  - APIエラー発生時にもフォールバック画像を選択する
  - フォールバック採用時に「生成失敗」または「生成遅延」の理由区分を記録する
  - フォールバック採用判定から表示可能状態への遷移を1秒以内に完了する
  - 生成リクエストとタイマーの競合パターンで制御する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 3.4 要求状態の追跡と可観測性ログを実装する
  - 各要求について「受付・生成中・生成成功・生成失敗・遅延フォールバック・配置完了」の状態遷移を記録する
  - フォールバック率がしきい値を超えた場合に警告イベントを発行する
  - 同一スポーンに対する短時間の重複要求を検知し、追跡可能な形で集約する
  - 要求識別子を用いて生成結果・フォールバック結果・配置結果を相互に照合可能にする
  - _Requirements: 5.1, 5.2, 5.3, 5.4_
  - _Contracts: ImageAgentServiceInterface_

- [ ] 4. React HookによるMUD同期とアセット解決の橋渡し
- [ ] 4.1 MUDのスポーンレコード変更を監視し、新規スポーンを検知するフックを実装する
  - MUDコンポーネントの同期イベントからスポーンレコードの変更を検知する
  - 検知した新規スポーンに対して画像生成サービスのアセット解決を呼び出す
  - 解決済みアセットのリストをReactの状態として公開する
  - 同一識別子による重複処理を防止する
  - 処理中状態とフォールバック率の情報を公開する
  - _Requirements: 4.1, 4.4, 1.1_
  - _Contracts: useImageAgent Hook_

- [ ] 5. Three.js空間内でのスプライト配置と表示
- [ ] 5.1 解決済みアセットをThree.js空間にスプライトとして配置するレンダラーを実装する
  - アセット確定時にスポーンイベントとしてThree.js表示系へ通知する
  - スポーン対象ごとに位置・識別子を含む配置情報を使用してスプライトを配置する
  - テクスチャデータURLからThree.jsテクスチャを生成しスプライトマテリアルに適用する
  - 配置先情報が欠落している場合は事前定義された安全な既定配置を使用する
  - 同一識別子による重複配置を防止する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 2.4_
  - _Contracts: SpawnedEntityRenderer_

- [ ] 6. エンドツーエンド統合と動作確認
- [ ] 6.1 全コンポーネントを結合し、スポーンから画像表示までの一連のフローを通して動作確認する
  - applyWorldPatch 実行後にスポーンされたエンティティがスプライトとして3D空間に表示されることを確認する
  - APIエラー・タイムアウト発生時にフォールバック画像が即時表示されることを確認する
  - 状態遷移ログがコンソールに正しく記録されることを確認する
  - 重複スポーンの防止動作を確認する
  - Cloud Run デプロイ後にリモート環境でも画像生成が正常に動作することを確認する
  - _Requirements: 1.1, 2.4, 3.1, 3.2, 4.1, 4.4, 5.1_

- [ ]\* 6.2 (P) ユニットテストを追加する
  - 画像生成サービスの正常系・タイムアウト系・エラー系のテストケースを作成する
  - フォールバックストアのプリロードと画像提供のテストケースを作成する
  - スポーン入力バリデーションの不正入力拒否を検証する
  - サーバー側エンドポイントのリクエスト・レスポンスバリデーションを検証する
  - _Requirements: 1.2, 2.2, 3.1, 3.2, 3.5_
